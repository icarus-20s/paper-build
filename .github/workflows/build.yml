name: Build & Release (Qt + CMake)

on:
  push:
    tags:
      - "v*.*.*"
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  QT_VERSION: 6.6.1       # You can change to any version from your list
  CMAKE_BUILD_TYPE: Release

jobs:
  build:
    name: Build on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            qt_arch: gcc_64
            artifact_name: Linux
          - os: windows-latest
            qt_arch: win64_msvc2019_64
            artifact_name: Windows

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # --------------------------
      # Install aqtinstall
      # --------------------------
      - name: Install aqtinstall
        run: pip install aqtinstall

      # --------------------------
      # Install Qt (cross-platform using aqt)
      # --------------------------
      - name: Install Qt (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m aqt install-qt linux desktop ${{ env.QT_VERSION }} ${{ matrix.qt_arch }} \
            --outputdir ${{ runner.temp }}/Qt

      - name: Install Qt (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m aqt install-qt windows desktop ${{ env.QT_VERSION }} ${{ matrix.qt_arch }} `
            --outputdir ${{ runner.temp }}/Qt

      # --------------------------
      # Setup Qt Environment
      # --------------------------
      - name: Setup Qt environment (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "CMAKE_PREFIX_PATH=${{ runner.temp }}/Qt/${{ env.QT_VERSION }}/${{ matrix.qt_arch }}" >> $GITHUB_ENV
          echo "${{ runner.temp }}/Qt/${{ env.QT_VERSION }}/${{ matrix.qt_arch }}/bin" >> $GITHUB_PATH

      - name: Setup Qt environment (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "CMAKE_PREFIX_PATH=${{ runner.temp }}/Qt/${{ env.QT_VERSION }}/${{ matrix.qt_arch }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "${{ runner.temp }}/Qt/${{ env.QT_VERSION }}/${{ matrix.qt_arch }}/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # --------------------------
      # Install Linux dependencies
      # --------------------------
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 \
          libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libxcb-cursor0 \
          libfontconfig1-dev libfreetype6-dev libx11-dev libx11-xcb-dev libxext-dev libxfixes-dev \
          libxi-dev libxrender-dev libxcb1-dev libxcb-glx0-dev libxcb-shm0-dev libxcb-util0-dev \
          libxcb-randr0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev

      # --------------------------
      # Configure and Build
      # --------------------------
      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=${{ env.CMAKE_PREFIX_PATH }}

      - name: Build
        run: cmake --build build --config ${{ env.CMAKE_BUILD_TYPE }} --parallel

      # --------------------------
      # Prepare release directory
      # --------------------------
      - name: Prepare release directory
        run: mkdir -p release

      # --------------------------
      # Bundle Windows Application
      # --------------------------
      - name: Bundle Windows App
        if: runner.os == 'Windows'
        run: |
          Copy-Item -Path "build/Release/*.exe" -Destination "release/" -Force
          & "${{ runner.temp }}/Qt/${{ env.QT_VERSION }}/${{ matrix.qt_arch }}/bin/windeployqt.exe" release/*.exe `
            --release --no-translations --no-system-d3d-compiler --no-opengl-sw
          Compress-Archive -Path release/* -DestinationPath "question-paper-system-windows.zip"

      # --------------------------
      # Bundle Linux Application
      # --------------------------
      - name: Bundle Linux App
        if: runner.os == 'Linux'
        run: |
          wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
          chmod a+x linuxdeployqt-continuous-x86_64.AppImage
          cp build/bin/question_paper_system release/
          export PATH=${{ runner.temp }}/Qt/${{ env.QT_VERSION }}/${{ matrix.qt_arch }}/bin:$PATH
          export LD_LIBRARY_PATH=${{ runner.temp }}/Qt/${{ env.QT_VERSION }}/${{ matrix.qt_arch }}/lib:$LD_LIBRARY_PATH
          ./linuxdeployqt-continuous-x86_64.AppImage build/bin/question_paper_system -appimage -no-translations -bundle-non-qt-libs || true
          if [ -f *.AppImage ]; then mv *.AppImage release/question-paper-system-linux-x86_64.AppImage; fi
          cd release && tar -czf question-paper-system-linux.tar.gz question_paper_system && cd ..

      # --------------------------
      # Upload Artifacts
      # --------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: question-paper-system-${{ matrix.artifact_name }}
          path: |
            release/*
            question-paper-system-*.zip
            question-paper-system-*.tar.gz
          retention-days: 7
